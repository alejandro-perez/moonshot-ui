/* moonshot-webp-parser.c generated by valac 0.10.4, the Vala compiler
 * generated from moonshot-webp-parser.vala, do not modify */


#include <glib.h>
#include <glib-object.h>
#include <stdlib.h>
#include <string.h>
#include <glib/gstdio.h>
#include <libmoonshot.h>
#include <stdio.h>


#define WEB_PROVISIONING_TYPE_PARSER (web_provisioning_parser_get_type ())
#define WEB_PROVISIONING_PARSER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), WEB_PROVISIONING_TYPE_PARSER, WebProvisioningParser))
#define WEB_PROVISIONING_PARSER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), WEB_PROVISIONING_TYPE_PARSER, WebProvisioningParserClass))
#define WEB_PROVISIONING_IS_PARSER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), WEB_PROVISIONING_TYPE_PARSER))
#define WEB_PROVISIONING_IS_PARSER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), WEB_PROVISIONING_TYPE_PARSER))
#define WEB_PROVISIONING_PARSER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), WEB_PROVISIONING_TYPE_PARSER, WebProvisioningParserClass))

typedef struct _WebProvisioningParser WebProvisioningParser;
typedef struct _WebProvisioningParserClass WebProvisioningParserClass;

#define TYPE_ID_CARD (id_card_get_type ())
#define ID_CARD(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_ID_CARD, IdCard))
#define ID_CARD_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_ID_CARD, IdCardClass))
#define IS_ID_CARD(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_ID_CARD))
#define IS_ID_CARD_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_ID_CARD))
#define ID_CARD_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_ID_CARD, IdCardClass))

typedef struct _IdCard IdCard;
typedef struct _IdCardClass IdCardClass;

#define TYPE_RULE (rule_get_type ())
typedef struct _Rule Rule;
#define _g_free0(var) (var = (g_free (var), NULL))

#define TYPE_TRUST_ANCHOR (trust_anchor_get_type ())
#define TRUST_ANCHOR(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_TRUST_ANCHOR, TrustAnchor))
#define TRUST_ANCHOR_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_TRUST_ANCHOR, TrustAnchorClass))
#define IS_TRUST_ANCHOR(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_TRUST_ANCHOR))
#define IS_TRUST_ANCHOR_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_TRUST_ANCHOR))
#define TRUST_ANCHOR_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_TRUST_ANCHOR, TrustAnchorClass))

typedef struct _TrustAnchor TrustAnchor;
typedef struct _TrustAnchorClass TrustAnchorClass;
#define _moonshot_error_free0(var) ((var == NULL) ? NULL : (var = (moonshot_error_free (var), NULL)))
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
#define _web_provisioning_parser_unref0(var) ((var == NULL) ? NULL : (var = (web_provisioning_parser_unref (var), NULL)))

struct _Rule {
	char* pattern;
	char* always_confirm;
};


extern IdCard** web_provisioning_cards;
extern gint web_provisioning_cards_length1;

gint web_provisioning_main (char** args, int args_length1);
WebProvisioningParser* web_provisioning_parser_new (const char* path);
WebProvisioningParser* web_provisioning_parser_construct (GType object_type, const char* path);
gpointer web_provisioning_parser_ref (gpointer instance);
void web_provisioning_parser_unref (gpointer instance);
GParamSpec* web_provisioning_param_spec_parser (const gchar* name, const gchar* nick, const gchar* blurb, GType object_type, GParamFlags flags);
void web_provisioning_value_set_parser (GValue* value, gpointer v_object);
void web_provisioning_value_take_parser (GValue* value, gpointer v_object);
gpointer web_provisioning_value_get_parser (const GValue* value);
GType web_provisioning_parser_get_type (void) G_GNUC_CONST;
void web_provisioning_parser_parse (WebProvisioningParser* self);
GType id_card_get_type (void) G_GNUC_CONST;
GType rule_get_type (void) G_GNUC_CONST;
Rule* rule_dup (const Rule* self);
void rule_free (Rule* self);
void rule_copy (const Rule* self, Rule* dest);
void rule_destroy (Rule* self);
Rule* id_card_get_rules (IdCard* self, int* result_length1);
const char* id_card_get_display_name (IdCard* self);
const char* id_card_get_username (IdCard* self);
const char* id_card_get_password (IdCard* self);
const char* id_card_get_issuer (IdCard* self);
char** id_card_get_services (IdCard* self, int* result_length1);
GType trust_anchor_get_type (void) G_GNUC_CONST;
TrustAnchor* id_card_get_trust_anchor (IdCard* self);
const char* trust_anchor_get_ca_cert (TrustAnchor* self);
const char* trust_anchor_get_subject (TrustAnchor* self);
const char* trust_anchor_get_subject_alt (TrustAnchor* self);
const char* trust_anchor_get_server_cert (TrustAnchor* self);
static void _vala_array_destroy (gpointer array, gint array_length, GDestroyNotify destroy_func);
static void _vala_array_free (gpointer array, gint array_length, GDestroyNotify destroy_func);



static gpointer _g_object_ref0 (gpointer self) {
	return self ? g_object_ref (self) : NULL;
}


gint web_provisioning_main (char** args, int args_length1) {
	gint result = 0;
	WebProvisioningParser* webp;
	if (args_length1 < 2) {
		g_error ("moonshot-webp-parser.vala:11: Usage %s [-a] WEB_PROVISIONING_FILE", args[0]);
	}
	if (!g_file_test (args[1], G_FILE_TEST_EXISTS | G_FILE_TEST_IS_REGULAR)) {
		g_error ("moonshot-webp-parser.vala:16: %s does not exist", args[1]);
	}
	webp = web_provisioning_parser_new (args[1]);
	web_provisioning_parser_parse (webp);
	{
		IdCard** card_collection;
		int card_collection_length1;
		int card_it;
		card_collection = web_provisioning_cards;
		card_collection_length1 = web_provisioning_cards_length1;
		for (card_it = 0; card_it < web_provisioning_cards_length1; card_it = card_it + 1) {
			IdCard* card;
			card = _g_object_ref0 (card_collection[card_it]);
			{
				MoonshotError* _error_;
				gint rules_patterns_length1;
				gint _rules_patterns_size_;
				char** _tmp1_;
				char** _tmp0_ = NULL;
				char** rules_patterns;
				gint rules_always_confirm_length1;
				gint _rules_always_confirm_size_;
				char** _tmp3_;
				char** _tmp2_ = NULL;
				char** rules_always_confirm;
				gint _tmp4_;
				gint _tmp13_;
				MoonshotError* _tmp14_ = NULL;
				MoonshotError* _tmp15_;
				_error_ = NULL;
				rules_patterns = (_tmp1_ = (_tmp0_ = g_new0 (char*, 0 + 1), _tmp0_), rules_patterns_length1 = 0, _rules_patterns_size_ = rules_patterns_length1, _tmp1_);
				rules_always_confirm = (_tmp3_ = (_tmp2_ = g_new0 (char*, 0 + 1), _tmp2_), rules_always_confirm_length1 = 0, _rules_always_confirm_size_ = rules_always_confirm_length1, _tmp3_);
				if (_tmp4_ > 0) {
					gint i;
					gint _tmp5_;
					char** _tmp6_;
					gint _tmp7_;
					char** _tmp8_;
					i = 0;
					rules_patterns = (_tmp6_ = g_new0 (char*, _tmp5_ + 1), rules_patterns = (_vala_array_free (rules_patterns, rules_patterns_length1, (GDestroyNotify) g_free), NULL), rules_patterns_length1 = _tmp5_, _rules_patterns_size_ = rules_patterns_length1, _tmp6_);
					rules_always_confirm = (_tmp8_ = g_new0 (char*, _tmp7_ + 1), rules_always_confirm = (_vala_array_free (rules_always_confirm, rules_always_confirm_length1, (GDestroyNotify) g_free), NULL), rules_always_confirm_length1 = _tmp7_, _rules_always_confirm_size_ = rules_always_confirm_length1, _tmp8_);
					{
						gint _tmp9_;
						Rule* r_collection;
						int r_collection_length1;
						int r_it;
						r_collection = id_card_get_rules (card, &_tmp9_);
						r_collection_length1 = _tmp9_;
						for (r_it = 0; r_it < _tmp9_; r_it = r_it + 1) {
							Rule _tmp12_ = {0};
							Rule r;
							r = (rule_copy (&r_collection[r_it], &_tmp12_), _tmp12_);
							{
								char* _tmp10_;
								char* _tmp11_;
								rules_patterns[i] = (_tmp10_ = g_strdup (r.pattern), _g_free0 (rules_patterns[i]), _tmp10_);
								rules_always_confirm[i] = (_tmp11_ = g_strdup (r.always_confirm), _g_free0 (rules_always_confirm[i]), _tmp11_);
								i++;
								rule_destroy (&r);
							}
						}
					}
				}
				moonshot_install_id_card (id_card_get_display_name (card), id_card_get_username (card), id_card_get_password (card), id_card_get_issuer (card), rules_patterns, rules_patterns_length1, rules_always_confirm, rules_always_confirm_length1, id_card_get_services (card, &_tmp13_), _tmp13_, trust_anchor_get_ca_cert (id_card_get_trust_anchor (card)), trust_anchor_get_subject (id_card_get_trust_anchor (card)), trust_anchor_get_subject_alt (id_card_get_trust_anchor (card)), trust_anchor_get_server_cert (id_card_get_trust_anchor (card)), &_tmp14_);
				_error_ = (_tmp15_ = _tmp14_, _moonshot_error_free0 (_error_), _tmp15_);
				if (_error_ != NULL) {
					fprintf (stderr, "Error: %s", _error_->message);
					rules_always_confirm = (_vala_array_free (rules_always_confirm, rules_always_confirm_length1, (GDestroyNotify) g_free), NULL);
					rules_patterns = (_vala_array_free (rules_patterns, rules_patterns_length1, (GDestroyNotify) g_free), NULL);
					_moonshot_error_free0 (_error_);
					_g_object_unref0 (card);
					continue;
				}
				rules_always_confirm = (_vala_array_free (rules_always_confirm, rules_always_confirm_length1, (GDestroyNotify) g_free), NULL);
				rules_patterns = (_vala_array_free (rules_patterns, rules_patterns_length1, (GDestroyNotify) g_free), NULL);
				_moonshot_error_free0 (_error_);
				_g_object_unref0 (card);
			}
		}
	}
	result = 0;
	_web_provisioning_parser_unref0 (webp);
	return result;
}


int main (int argc, char ** argv) {
	g_type_init ();
	return web_provisioning_main (argv, argc);
}


static void _vala_array_destroy (gpointer array, gint array_length, GDestroyNotify destroy_func) {
	if ((array != NULL) && (destroy_func != NULL)) {
		int i;
		for (i = 0; i < array_length; i = i + 1) {
			if (((gpointer*) array)[i] != NULL) {
				destroy_func (((gpointer*) array)[i]);
			}
		}
	}
}


static void _vala_array_free (gpointer array, gint array_length, GDestroyNotify destroy_func) {
	_vala_array_destroy (array, array_length, destroy_func);
	g_free (array);
}




